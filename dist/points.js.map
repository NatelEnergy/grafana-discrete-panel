{"version":3,"sources":["../src/points.js"],"names":["_","DistinctPoints","name","changes","legendInfo","last","asc","ts","val","start","ms","push","console","log","length","ctrl","reverse","range","to","transitionCount","valToInfo","lastTS","legendCount","maxLegendSize","panel","legendMaxValues","i","pt","s","e","from","has","v","count","elapsed","nullText","formatValue","info","per","splice","forEach","value","distinctValuesCount","size"],"mappings":"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","file":"points.js","sourcesContent":["import _ from \"lodash\";\n\nexport default class DistinctPoints {\n\n  constructor(name) {\n    this.name = name;\n    this.changes = [];\n    this.legendInfo = [];\n\n    // last point we added\n    this.last = null;\n    this.asc = false;\n  }\n\n  // ts numeric ms,\n  // val is the normalized value\n  add( ts, val ) {\n    if(this.last == null) {\n      this.last = {\n        val: val,\n        start: ts,\n        ms: 0\n      };\n      this.changes.push(this.last);\n    }\n    else if(ts == this.last.ts ) {\n      console.log('skip point with duplicate timestamp', ts, val);\n      return;\n    }\n    else {\n      if(this.changes.length === 1) {\n        this.asc = ts > this.last.start;\n      }\n\n      if( (ts > this.last.start) != this.asc ) {\n        console.log('skip out of order point', ts, val);\n        return;\n      }\n\n      // Same value\n      if(val == this.last.val) {\n        if(!this.asc) {\n          this.last.start = ts;\n        }\n      }\n      else {\n        this.last = {\n          val: val,\n          start: ts,\n          ms: 0\n        };\n        this.changes.push(this.last);\n      }\n    }\n  }\n\n  finish(ctrl) {\n    if(this.changes.length<1) {\n      console.log( \"no points found!\" );\n      return;\n    }\n\n\n    if(!this.asc) {\n      this.last = this.changes[0];\n      _.reverse(this.changes);\n    }\n\n    // Add a point beyond the controls\n    if(this.last.start < ctrl.range.to) {\n      this.changes.push( {\n        val: this.last.val,\n        start: ctrl.range.to+1,\n        ms: 0\n      });\n    }\n\n    this.transitionCount = 0;\n    var valToInfo = {};\n    var lastTS = 0;\n    var legendCount = 0;\n    var maxLegendSize = ctrl.panel.legendMaxValues;\n    if(!maxLegendSize) {\n      maxLegendSize = 20;\n    }\n    var last = this.changes[0];\n    for(var i=1; i<this.changes.length; i++) {\n      var pt = this.changes[i];\n\n      var s = last.start;\n      var e = pt.start;\n      if( s < ctrl.range.from ) {\n        s = ctrl.range.from;\n      }\n      else if(s<ctrl.range.to) {\n        this.transitionCount++;\n      }\n\n      if( e > ctrl.range.to ) {\n        e = ctrl.range.to;\n      }\n\n      last.ms = e - s;\n      if(last.ms>0) {\n        if(_.has(valToInfo, last.val)) {\n          var v = valToInfo[last.val];\n          v.ms += last.ms;\n          v.count++;\n        }\n        else {\n          valToInfo[last.val] = { 'val': last.val, 'ms': last.ms, 'count':1 };\n          legendCount++;\n        }\n      }\n      last = pt;\n    }\n\n    var elapsed = ctrl.range.to - ctrl.range.from;\n    this.elapsed = elapsed;\n\n    // Remove null from the legend if it is the first value and small (common for influx queries)\n    var nullText = ctrl.formatValue(null);\n    if( this.changes.length > 1 && _.has(valToInfo, nullText ) ) {\n      var info = valToInfo[nullText];\n      if(info.count == 1 ) {\n        var per = (info.ms/elapsed);\n        if( per < .02 ) {\n          if(this.changes[0].val == nullText) {\n            console.log( 'Removing null', info );\n            delete valToInfo[nullText];\n\n            this.changes[1].start = this.changes[0].start;\n            this.changes[1].ms += this.changes[0].ms;\n            this.changes.splice(0, 1);\n          }\n        }\n      }\n    }\n    _.forEach(valToInfo, (value) => {\n      value.per = (value.ms/elapsed);\n      this.legendInfo.push( value );\n    });\n    this.distinctValuesCount = _.size(this.legendInfo);\n    //console.log( \"FINISH\", valToInfo, this );\n  }\n}\n"]}