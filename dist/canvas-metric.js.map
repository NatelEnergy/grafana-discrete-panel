{"version":3,"sources":["../src/canvas-metric.js"],"names":["MetricsPanelCtrl","_","moment","angular","CanvasPanelCtrl","$scope","$injector","$q","q","data","mouse","position","down","$tooltip","$","events","on","onPanelInitalized","bind","onRefresh","onRender","console","log","render","context","rect","wrap","getBoundingClientRect","height","Math","max","width","canvas","centerV","ctx","lineWidth","textBaseline","time","dashboard","formatDate","ts","fillStyle","fillRect","font","textAlign","fillText","xmin","min","x","xmax","globalCompositeOperation","beginPath","fill","strokeStyle","moveTo","lineTo","stroke","detach","evt","clientX","left","elapsed","range","to","from","y","clientY","top","pos","body","html","place_tt","pageX","pageY","where","scope","elem","attrs","ctrl","find","document","createElement","appendChild","css","getContext","addEventListener","getMousePosition","onMouseMoved","up","onMouseClicked","utc","onMouseSelectedRange"],"mappings":"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","file":"canvas-metric.js","sourcesContent":["\nimport {MetricsPanelCtrl} from  'app/plugins/sdk';\n\nimport _ from 'lodash';\nimport moment from 'moment';\nimport angular from 'angular';\n\n// Expects a template with:\n// <div class=\"canvas-spot\"></div>\nexport class CanvasPanelCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $q) {\n    super($scope, $injector);\n\n    this.q = $q;\n    this.data = null;\n    this.mouse = {\n      position: null,\n      down: null,\n    };\n    this.$tooltip = $('<div id=\"tooltip\" class=\"graph-tooltip\">');\n\n    this.events.on('panel-initialized', this.onPanelInitalized.bind(this));\n    this.events.on('refresh', this.onRefresh.bind(this));\n    this.events.on('render', this.onRender.bind(this));\n\n    console.log( 'constructor', this );\n  }\n\n  onPanelInitalized() {\n    console.log(\"onPanelInitalized()\");\n    this.render();\n  }\n\n  onRefresh() {\n    console.log(\"onRefresh()\");\n    this.render();\n  }\n\n  // Typically you will override this\n  onRender() {\n    if( !(this.context) ) {\n      console.log( 'No context!');\n      return;\n    }\n    console.log( 'canvas render', this.mouse );\n\n    var rect = this.wrap.getBoundingClientRect();\n\n\n    var height = Math.max( this.height, 100 );\n    var width = rect.width;\n    this.canvas.width = width;\n    this.canvas.height = height;\n\n    var centerV = height / 2;\n\n    var ctx = this.context;\n    ctx.lineWidth = 1;\n    ctx.textBaseline = 'middle';\n\n    var time = \"\";\n    if(this.mouse.position != null) {\n      time = this.dashboard.formatDate( moment(this.mouse.position.ts) );\n    }\n\n    ctx.fillStyle = '#999999';\n    ctx.fillRect(0, 0, width, height);\n    ctx.fillStyle = \"#111111\";\n    ctx.font = '24px \"Open Sans\", Helvetica, Arial, sans-serif';\n    ctx.textAlign = 'left';\n    ctx.fillText(\"Mouse @ \"+time, 10, centerV);\n\n\n\n    if(this.mouse.position != null ) {\n      if(this.mouse.down != null) {\n        var xmin = Math.min( this.mouse.position.x, this.mouse.down.x);\n        var xmax = Math.max( this.mouse.position.x, this.mouse.down.x);\n\n        // Fill canvas using 'destination-out' and alpha at 0.05\n        ctx.globalCompositeOperation = 'destination-out';\n        ctx.fillStyle = \"rgba(255, 255, 255, 0.6)\";\n        ctx.beginPath();\n        ctx.fillRect(0, 0, xmin, height);\n        ctx.fill();\n\n        ctx.beginPath();\n        ctx.fillRect(xmax, 0, width, height);\n        ctx.fill();\n        ctx.globalCompositeOperation = 'source-over';\n      }\n      else {\n        ctx.strokeStyle = '#111';\n        ctx.beginPath();\n        ctx.moveTo(this.mouse.position.x, 0);\n        ctx.lineTo(this.mouse.position.x, height);\n        ctx.lineWidth = 3;\n        ctx.stroke();\n\n        ctx.beginPath();\n        ctx.moveTo(this.mouse.position.x, 0);\n        ctx.lineTo(this.mouse.position.x, height);\n        ctx.strokeStyle = '#e22c14';\n        ctx.lineWidth = 2;\n        ctx.stroke();\n      }\n    }\n  }\n\n  clearTT() {\n    this.$tooltip.detach(); \n  }\n\n  getMousePosition(evt) {\n    var rect = this.canvas.getBoundingClientRect();\n    var x = evt.clientX - rect.left;\n    var elapsed = this.range.to - this.range.from;\n    var ts = this.range.from + (elapsed*(x/rect.width));\n\n    return {\n      x: x,\n      y: evt.clientY - rect.top,\n      ts: ts,\n      evt: evt\n    };\n  }\n\n  onMouseMoved(evt) {\n\n    var pos = this.mouse.position;\n    var body = '<div class=\"graph-tooltip-time\">hello</div>';\n    \n    body += \"<center>\"\n    body += this.dashboard.formatDate( moment(pos.ts) );\n    body += \"</center>\"\n\n    this.$tooltip.html(body).place_tt(pos.evt.pageX + 20, pos.evt.pageY);\n\n    this.render();\n  }\n\n  onMouseClicked(where) {\n    console.log( \"CANVAS CLICKED\", where );\n    this.render();\n  }\n\n  onMouseSelectedRange(range) {\n    console.log( \"CANVAS Range\", range );\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    this.wrap = elem.find('.canvas-spot')[0];\n    this.canvas = document.createElement(\"canvas\");\n    this.wrap.appendChild(this.canvas);\n\n    $(this.canvas).css( 'cursor', 'pointer' );\n    $(this.wrap).css( 'width', '100%' );\n\n    console.log( 'link', this );\n\n    this.context = this.canvas.getContext('2d');\n    this.canvas.addEventListener('mousemove', (evt) => {\n      this.mouse.position = this.getMousePosition(evt);\n      this.onMouseMoved(evt);\n    }, false);\n\n    this.canvas.addEventListener('mouseout', (evt) => {\n      this.mouse.position = null;\n      this.mouse.down = null;\n      this.onRender(); \n      this.$tooltip.detach();\n    }, false);\n\n    this.canvas.addEventListener('mousedown', (evt) => {\n      this.mouse.down = this.getMousePosition(evt);\n      $(this.canvas).css( 'cursor', 'col-resize' );\n    }, false);\n\n    this.canvas.addEventListener('mouseenter', (evt) => {\n      $(this.canvas).css( 'cursor', 'pointer' );\n    }, false);\n\n    this.canvas.addEventListener('mouseup', (evt) => {\n      var up = this.getMousePosition(evt);\n      if(this.mouse.down != null) {\n        if(up.x == this.mouse.down.x && up.y == this.mouse.down.y ) {\n          this.onMouseClicked(up);\n        }\n        else {\n          var min = Math.min(this.mouse.down.ts, up.ts);\n          var max = Math.max(this.mouse.down.ts, up.ts);\n          var range = {from: moment.utc(min), to: moment.utc(max) };\n          this.mouse.position = up;\n          this.onMouseSelectedRange(range);\n        }\n      }\n      this.mouse.down = null;\n      this.mouse.position = null;\n      this.$tooltip.detach();\n    }, false);\n  }\n}\n\n"]}